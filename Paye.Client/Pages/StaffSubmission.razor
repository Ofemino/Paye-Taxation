@page "/staff/submission"
@inject Paye.Client.Services.ApiClient ApiClient
@inject NavigationManager Navigation
@using Paye.Client.DTOs
@using Microsoft.AspNetCore.Components.Forms

<h3>Tax Relief Submission</h3>

<div class="container">
    <EditForm Model="@_submission" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Tax Year</label>
            <InputNumber class="form-control" @bind-Value="_submission.TaxYear" />
        </div>

        <div class="mb-3">
            <label class="form-label">Ownership Type</label>
            <InputSelect class="form-control" @bind-Value="_submission.OwnershipType">
                <option value="">Select...</option>
                <option value="Tenant">Tenant</option>
                <option value="Landlord">Landlord</option>
            </InputSelect>
        </div>

        @if (_submission.OwnershipType == "Tenant")
        {
            <div class="card p-3 mb-3">
                <h5>Rent Relief Details</h5>
                <div class="mb-3">
                    <label class="form-label">Annual Rent</label>
                    <InputNumber class="form-control" @bind-Value="_submission.AnnualRent" />
                </div>
            </div>
        }

        @if (_submission.OwnershipType == "Landlord")
        {
            <div class="card p-3 mb-3">
                <h5>Mortgage Interest Relief Details</h5>
                <div class="mb-3">
                    <label class="form-label">Deductible Interest</label>
                    <InputNumber class="form-control" @bind-Value="_submission.DeductibleInterest" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Amortization Schedule (Upload)</label>
                    <InputFile OnChange="UploadAmortizationSchedule" />
                    @if (!string.IsNullOrEmpty(_submission.AmortizationScheduleFile))
                    {
                        <span class="text-success">Uploaded: @_submission.AmortizationScheduleFile</span>
                    }
                </div>
            </div>
        }

        <div class="mb-3">
            <label class="form-label">Supporting Documents</label>
            <InputFile OnChange="UploadSupportingDocs" multiple />
            <ul>
                @foreach (var doc in _submission.SupportingDocuments)
                {
                    <li>@doc.FileName</li>
                }
            </ul>
        </div>

        <button type="submit" class="btn btn-primary">Submit Application</button>
    </EditForm>
    
    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="alert alert-info mt-3">@_message</div>
    }
</div>

@inject AuthenticationStateProvider AuthStateProvider


@code {
    private TaxReliefSubmissionDto _submission = new() { TaxYear = DateTime.Now.Year };
    private string? _message;

    private async Task UploadAmortizationSchedule(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var content = new MultipartFormDataContent();
        content.Add(new StreamContent(file.OpenReadStream(10 * 1024 * 1024)), "file", file.Name);
        
        var path = await ApiClient.UploadDocumentAsync(content);
        if (path != null)
        {
            _submission.AmortizationScheduleFile = path;
        }
    }

    private async Task UploadSupportingDocs(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var content = new MultipartFormDataContent();
            content.Add(new StreamContent(file.OpenReadStream(10 * 1024 * 1024)), "file", file.Name);
            
            var path = await ApiClient.UploadDocumentAsync(content);
            if (path != null)
            {
                _submission.SupportingDocuments.Add(new SupportingDocumentDto
                {
                    FileName = file.Name,
                    FileType = file.ContentType,
                    StoragePath = path
                });
            }
        }
    }

    private async Task HandleSubmit()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var staffId))
            {
                _submission.StaffId = staffId;
            }
            else
            {
                 // Fallback for demo or if claim logic differs (e.g. backend handles it)
                 if (_submission.StaffId == Guid.Empty) _submission.StaffId = Guid.NewGuid();
            }
        }
        else
        {
             _message = "You must be logged in to submit.";
             return;
        }

        var result = await ApiClient.SubmitTaxReliefAsync(_submission);
        if (result)
        {
            _message = "Submission created successfully!";
            _submission = new() { TaxYear = DateTime.Now.Year };
        }
        else
        {
            _message = "Error creating submission.";
        }
    }
}
